<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Voyager | Premium Trip Planner</title>

    <!-- External Assets -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            future: {
                hoverOnlyWhenSupported: true,
            },
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.4s ease-out forwards',
                        'glow': 'glow 2s infinite alternate',
                        'float': 'float 4s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        glow: { '0%': { boxShadow: '0 0 5px rgba(59, 130, 246, 0.2)' }, '100%': { boxShadow: '0 0 20px rgba(59, 130, 246, 0.4)' } },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-15px)' },
                        },
                        marquee: {
                            '0%': { transform: 'translateX(0)' },
                            '100%': { transform: 'translateX(-100%)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Theme Variables */
        :root {
            --bg-color: #f8fafc;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-light-bg: rgba(255, 255, 255, 0.4);
            --sidebar-bg: #ffffff;
            --card-bg: #ffffff;
            --card-border: rgba(15, 23, 42, 0.08);
            --input-bg: #ffffff;
            --input-border: #d1d5db;
            --modal-bg: #ffffff;
            --modal-backdrop: rgba(15, 23, 42, 0.4);
            --icon-filter: invert(0);
            --accent-blue: #3b82f6;
            --accent-blue-hover: #2563eb;
            --indicator-green: #22c55e;
            --card-selected-bg: rgba(37, 99, 235, 0.05);
            --card-selected-border: rgba(37, 99, 235, 0.4);
            --cal-range-bg: #dbeafe;
            --cal-range-text: #1e40af;
            --dropdown-shadow: 0 15px 35px -5px rgba(0, 0, 0, 0.15), 0 5px 15px -5px rgba(0, 0, 0, 0.05);
        }

        html.dark {
            --bg-color: #0f172a;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-light-bg: rgba(255, 255, 255, 0.03);
            --sidebar-bg: #0f172a;
            --card-bg: #1e293b;
            --card-border: rgba(255, 255, 255, 0.05);
            --input-bg: #0f172a;
            --input-border: #334155;
            --modal-bg: #1e293b;
            --modal-backdrop: rgba(0, 0, 0, 0.8);
            --icon-filter: invert(1);
            --accent-blue: #3b82f6;
            --accent-blue-hover: #60a5fa;
            --card-selected-bg: rgba(59, 130, 246, 0.1);
            --card-selected-border: rgba(59, 130, 246, 0.5);
            --cal-range-bg: #1e3a8a;
            --cal-range-text: #bfdbfe;
            --dropdown-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.5);
        }

        /* Modern Scrollbar Hide */
        *::-webkit-scrollbar { display: none; }
        * { -ms-overflow-style: none; scrollbar-width: none; }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            transition: background-color 0.4s ease, color 0.4s ease;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        .text-muted { color: var(--text-muted); }
        .bg-accent { background-color: var(--accent-blue); }
        .bg-accent:hover { background-color: var(--accent-blue-hover); }

        /* Glassmorphism Classes */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            border: 1px solid var(--card-border);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.03);
        }

        /* Input Styling */
        .floating-group { position: relative; }
        .floating-input, .floating-textarea, .floating-select {
            display: block; width: 100%; height: 56px; padding: 14px 12px 0 12px;
            font-size: 14px; background-color: var(--input-bg); color: var(--text-main);
            border: 1px solid var(--input-border); border-radius: 0.5rem;
            outline: none; transition: border-color 0.2s;
        }
        .floating-textarea { height: 120px; min-height: 120px; padding-top: 22px; resize: none; overflow-y: hidden; }

        .floating-label {
            position: absolute; top: 50%; left: 12px; transform: translateY(-50%);
            font-size: 14px; color: var(--text-muted); pointer-events: none;
            transition: all 0.2s ease; z-index: 10;
        }

        .floating-input:focus ~ .floating-label,
        .floating-input:not(:placeholder-shown) ~ .floating-label,
        .floating-textarea:focus ~ .floating-label,
        .floating-textarea:not(:placeholder-shown) ~ .floating-label,
        .floating-select:focus ~ .floating-label,
        .floating-select:not([value=""]) ~ .floating-label {
            top: 10px; left: 10px; font-size: 11px; color: var(--accent-blue);
            transform: translateY(0); font-weight: 500;
        }

        .floating-input:focus, .floating-textarea:focus, .floating-select:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 1px var(--accent-blue);
        }

        /* Theme-aware Date/Time Picker Icons */
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: var(--icon-filter);
            cursor: pointer;
        }

        /* Suggestions Dropdown */
        .suggestions-list {
            position: absolute; top: calc(100% + 4px); left: 0; right: 0;
            border-radius: 0.5rem; overflow: hidden; z-index: 500;
            max-height: 180px; overflow-y: auto; display: none;
            background: var(--modal-bg); border: 1px solid var(--card-border);
            box-shadow: var(--dropdown-shadow); animation: slideUp 0.2s ease-out forwards;
        }
        .suggestion-item { padding: 14px 16px; cursor: pointer; font-size: 14px; color: var(--text-main); border-bottom: 1px solid var(--card-border); }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background: var(--cal-range-bg); color: var(--accent-blue); }

        /* Custom Calendar Grid */
        .calendar-day-btn {
            height: 2.5rem; width: 100%; display: flex; align-items: center; justify-content: center;
            font-size: 0.875rem; position: relative; z-index: 10; transition: all 0.2s; border-radius: 0.5rem;
            cursor: pointer;
        }
        .calendar-day-btn::before { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); height: 100%; width: 100%; z-index: -1; display: none; }
        .calendar-day-btn.is-start, .calendar-day-btn.is-end { color: white !important; font-weight: 600; }
        .calendar-day-btn.is-start::before, .calendar-day-btn.is-end::before { display: block; background-color: var(--accent-blue); border-radius: 0.5rem; }

        /* SEAMLESS CAPSULE LOGIC */
        .calendar-day-btn.is-start.has-end::before { border-top-right-radius: 0; border-bottom-right-radius: 0; }
        .calendar-day-btn.is-end.has-start::before { border-top-left-radius: 0; border-bottom-left-radius: 0; }

        .calendar-day-btn.in-range { color: var(--cal-range-text); }
        .calendar-day-btn.in-range::before { display: block; background-color: var(--cal-range-bg); border-radius: 0; width: calc(100% + 2px); left: -1px; transform: translateY(-50%); }

        /* Navigation & Sidebar */
        .sidebar { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 100; background: var(--sidebar-bg); border-right: 1px solid var(--card-border); }
        .sidebar.closed { transform: translateX(-100%); }

        /* Itinerary Layout */
        .day-header {
            position: sticky;
            top: 48px;
            z-index: 40;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        @media (min-width: 768px) {
            .day-header { top: 56px; }
        }

        .plan-item {
            transition: transform 0.2s ease, opacity 0.2s ease;
            position: relative;
            overflow: visible;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
        }

        .plan-item::before {
            content: '';
            position: absolute;
            inset: -10.5px 0;
            z-index: 1;
            pointer-events: auto;
        }

        .plan-item:active { transform: scale(0.98); }

        .status-fin { position: absolute; left: 0; top: 0; bottom: 0; width: 4px; border-radius: 0.5rem 0 0 0.5rem; z-index: 2; }
        .fin-Confirmed { background-color: #10b981; }
        .fin-Tentative { background-color: #f59e0b; }
        .fin-Cancelled { background-color: #ef4444; }

        /* CINEMATIC COLLAPSE PHYSICS */
        .day-content-wrapper {
            display: grid;
            grid-template-rows: 1fr;
            transform: translateY(0);
            opacity: 1;
            transition:
                grid-template-rows 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                opacity 0.3s ease-out,
                transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: visible;
            will-change: grid-template-rows, transform, opacity;
        }
        .day-content-wrapper.collapsed {
            grid-template-rows: 0fr;
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none;
            overflow: hidden;
            transition:
                grid-template-rows 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                opacity 0.2s ease-in,
                transform 0.3s ease-in;
        }

        .day-content-wrapper.collapsed .day-content-inner {
            transform: translateY(-20px);
        }

        .day-content-inner {
            min-height: 0;
            min-width: 0; /* Prevent grid item blowout */
            overflow: visible;
            transform: translateY(0);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #global-drag-indicator {
            position: absolute;
            height: 2px;
            background-color: var(--indicator-green);
            z-index: 200;
            border-radius: 2px;
            pointer-events: none;
            display: none;
        }

        .dragging { opacity: 0.1 !important; transform: scale(0.95); border: none !important; }
        .drag-over-day .day-header { outline: 2px dashed var(--accent-blue) !important; outline-offset: -2px; }
        .drag-over-day { border: none !important; background: transparent !important; }

        /* Marquee specific styles */
        .marquee-container {
            position: relative;
            overflow: hidden;
            flex-grow: 1;
            display: flex; /* Prevent wrapping */
            min-width: 0;
        }

        .marquee-content {
            display: inline-block;
            white-space: nowrap;
        }

        .marquee-active .marquee-content {
            animation: marquee 12s linear infinite;
            padding-right: 2rem;
        }

        /* Stop marquee on interaction to prevent ghost card offset */
        .plan-item:active .marquee-content,
        .plan-item.dragging .marquee-content {
            animation: none !important;
            transform: translateX(0) !important;
        }

        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }

        /* Clone for seamless loop if needed, but simple scroll is requested */
        /* To make it seamless, we might need JS to duplicate text, but simple scroll is safer with CSS only */

        #vibe-debugger { position: fixed; bottom: 12px; right: 12px; width: 10px; height: 10px; border-radius: 50%; z-index: 9999; opacity: 0.6; background: #22c55e; cursor: pointer; border: 2px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.1); transition: background 0.2s; }
        #vibe-debugger.error { background: #ef4444; animation: glow 1s infinite alternate; }
        #vibe-debugger.locked { background: #06b6d4; }

        /* Force remove focus/tap highlight from theme button */
        #theme-toggle-btn, #theme-toggle-btn:focus, #theme-toggle-btn:active, #theme-toggle-btn:focus-visible {
            outline: none !important;
            box-shadow: none !important;
            -webkit-tap-highlight-color: transparent !important;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Cinematic Loader -->
    <div id="loader" class="fixed inset-0 z-[200] bg-white dark:bg-slate-900 flex flex-col items-center justify-center transition-opacity duration-700">
        <div class="relative w-24 h-24 mb-8">
            <div class="absolute inset-0 border-4 border-slate-100 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-blue-500 rounded-full border-t-transparent animate-spin"></div>
            <i class="fa-solid fa-plane-departure absolute inset-0 flex items-center justify-center text-3xl text-blue-500"></i>
        </div>
        <h1 class="text-2xl font-black tracking-tighter text-slate-900 dark:text-white uppercase italic text-center leading-none">Voyager</h1>
    </div>

    <!-- Sidebar -->
    <nav id="sidebar" class="sidebar closed fixed inset-y-0 left-0 w-80 z-[110] p-6 flex flex-col">
        <div class="flex justify-between items-center mb-10">
            <h2 class="text-xl font-bold tracking-tight text-current flex items-center">
                <i class="fa-solid fa-earth-americas mr-3 text-blue-500"></i> My Journeys
            </h2>
            <button onclick="toggleSidebar()" class="text-muted hover:text-current transition-colors"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>
        <div id="trip-list" class="flex-grow overflow-y-auto space-y-3 pr-2"></div>
        <button onclick="openTripModal(null)" class="mt-6 w-full py-4 bg-accent text-white font-bold rounded-lg transition-all shadow-lg flex items-center justify-center">
            <i class="fa-solid fa-plus mr-2"></i> New Expedition
        </button>
    </nav>

    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-slate-900/20 backdrop-blur-sm z-[105] hidden transition-opacity duration-300"></div>

    <!-- Main Content -->
    <main id="app-root" class="min-h-screen pb-24">
        <header class="fixed top-0 left-0 right-0 h-14 md:h-16 glass !border-t-0 !border-x-0 z-50 px-4 md:px-8 flex items-center justify-between">
            <button onclick="toggleSidebar()" class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-slate-100/20 transition-colors">
                <i class="fa-solid fa-bars-staggered text-xl text-blue-600"></i>
            </button>
            <div id="trip-header-title" class="absolute left-1/2 -translate-x-1/2 max-w-[60%] text-center text-sm md:text-lg font-bold tracking-tight text-current uppercase truncate px-4">Voyager</div>
            <div class="flex items-center space-x-2">
                <button id="theme-toggle-btn" onclick="toggleTheme()" class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-slate-100/20 transition-colors">
                    <i id="theme-icon" class="fa-solid fa-moon text-muted"></i>
                </button>
                <button id="edit-current-trip" class="hidden w-10 h-10 flex items-center justify-center rounded-lg hover:bg-slate-100/20 transition-colors">
                    <i class="fa-solid fa-pen-to-square text-muted"></i>
                </button>
            </div>
        </header>

        <!-- CONTENT UPDATED: 97vw width for widescreen cinematic feel -->
        <div id="content" class="pt-16 md:pt-20 px-0 md:px-8 w-full md:w-[97vw] mx-auto">
            <div id="trip-hero" class="relative w-[95%] md:w-full mx-auto h-48 md:h-64 rounded-lg overflow-hidden mb-8 hidden animate-fade-in shadow-xl">
                <img id="hero-img" src="" alt="Travel" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-slate-900/60 via-transparent to-transparent"></div>
                <div class="absolute bottom-6 left-6 right-6">
                    <h1 id="hero-title" class="text-3xl md:text-5xl font-black text-white tracking-tighter uppercase italic">Adventure</h1>
                    <p id="hero-dates" class="text-blue-200 font-medium text-sm md:text-base mt-1"></p>
                </div>
            </div>

            <div id="itinerary-list" class="relative space-y-6"></div>

            <div id="empty-state" class="flex flex-col items-center justify-center py-24 text-center hidden">
                <div class="flex items-center justify-center mb-8">
                    <i class="fa-solid fa-map-location-dot text-7xl text-muted/30 dark:text-muted/20 animate-float"></i>
                </div>
                <h3 class="text-2xl font-black text-current mb-2 italic uppercase tracking-tighter">No active itinerary</h3>
                <p class="text-muted text-sm mb-8 max-w-xs mx-auto">Your next adventure is waiting to be mapped out. Start your expedition today.</p>
                <button onclick="openTripModal(null)" class="px-10 py-4 bg-accent text-white rounded-xl font-bold transition-all shadow-xl hover:scale-105 active:scale-95">Create Trip</button>
            </div>
        </div>
    </main>

    <div id="vibe-debugger" onclick="copyLogs()"></div>

    <!-- Modals -->
    <div id="modal-container" class="fixed inset-0 z-[150] hidden items-center justify-center p-4">
        <div id="modal-backdrop" onclick="closeModal()" class="absolute inset-0 bg-slate-900/40 backdrop-blur-md"></div>
        <div id="modal-content" class="relative w-full max-w-md bg-[var(--modal-bg)] p-6 rounded-lg shadow-2xl max-h-[85vh] flex flex-col animate-slide-up border border-[var(--card-border)]"></div>
    </div>

    <script>
        const DB_NAME = 'Voyager_V4';
        const STORE_NAME = 'expeditions';
        const COLLAPSE_KEY = 'voyager_collapsed_days';
        const THEME_KEY = 'voyager_theme';

        let db, trips = [], activeTrip = null, logs = [], pendingTripCache = null;
        let collapsedDays = JSON.parse(localStorage.getItem(COLLAPSE_KEY) || '{}');

        // Custom Calendar State
        let calSelectionStart = null;
        let calSelectionEnd = null;
        let calCurrentMonth = new Date().getMonth();
        let calCurrentYear = new Date().getFullYear();

        const $ = (id) => document.getElementById(id);

        const log = (msg, type = 'LOG') => {
            const entry = `[${type}] ${new Date().toLocaleTimeString()} - ${msg}`;
            logs.push(entry);
            if (type === 'ERROR') {
                $('vibe-debugger').classList.add('error');
                console.error(entry);
            }
        };

        const escapeHtml = (unsafe) => {
            return (unsafe || "")
                 .toString()
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        };

        const showNotification = (msg) => {
            document.querySelectorAll('.toast-wrapper').forEach(el => el.remove());

            const wrapper = document.createElement('div');
            wrapper.className = 'toast-wrapper fixed inset-0 pointer-events-none flex items-center justify-center z-[300] p-6';

            const toast = document.createElement('div');
            toast.className = 'pointer-events-auto bg-[var(--modal-bg)] text-[var(--text-main)] px-6 py-4 md:px-10 md:py-6 rounded-2xl font-black shadow-[0_30px_70px_-10px_rgba(0,0,0,0.5)] border-2 border-blue-500 flex flex-col items-center justify-center space-y-2 md:space-y-3 animate-slide-up uppercase tracking-tighter italic text-center max-w-[85vw] md:max-w-sm';

            toast.innerHTML = `<i class="fa-solid fa-circle-check text-blue-500 text-xl md:text-3xl"></i><span class="text-sm md:text-lg leading-tight">${msg}</span>`;

            wrapper.appendChild(toast);
            document.body.appendChild(wrapper);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'scale(0.85) translateY(20px)';
                toast.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
                setTimeout(() => wrapper.remove(), 600);
            }, 2500);
        };

        const copyLogs = () => {
            const el = document.createElement('textarea');
            el.value = logs.join('\n'); document.body.appendChild(el);
            el.select(); document.execCommand('copy'); document.body.removeChild(el);
            showNotification("Logs copied to clipboard.");
        };

        const initDB = () => new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, 1);
            request.onupgradeneeded = (event) => {
                db = event.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                }
            };
            request.onsuccess = (event) => {
                db = event.target.result;
                log("Database initialized");
                resolve(db);
            };
            request.onerror = (event) => {
                log(event.target.error, 'ERROR');
                reject(event.target.error);
            };
        });

        const saveToDB = (data) => {
            const tx = db.transaction(STORE_NAME, 'readwrite');
            tx.objectStore(STORE_NAME).put(data);
            return new Promise((r) => tx.oncomplete = r);
        };

        const deleteFromDB = (id) => {
            const tx = db.transaction(STORE_NAME, 'readwrite');
            tx.objectStore(STORE_NAME).delete(id);
            return new Promise((r) => tx.oncomplete = r);
        };

        window.loadAll = () => new Promise((r) => {
            const req = db.transaction(STORE_NAME, 'readonly').objectStore(STORE_NAME).getAll();
            req.onsuccess = () => r(req.result);
        });

        const initTheme = () => {
            const saved = localStorage.getItem(THEME_KEY);
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (saved === 'dark' || (!saved && prefersDark)) {
                document.documentElement.classList.add('dark');
                const icon = $('theme-icon');
                if (icon) { icon.classList.replace('fa-moon', 'fa-sun'); icon.classList.add('text-amber-400'); }
            }
        };

        const toggleTheme = () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem(THEME_KEY, isDark ? 'dark' : 'light');
            const icon = $('theme-icon');
            if (isDark) {
                icon.classList.replace('fa-moon', 'fa-sun'); icon.classList.add('text-amber-400');
                showNotification("Night mode active.");
            } else {
                icon.classList.replace('fa-sun', 'fa-moon'); icon.classList.remove('text-amber-400');
                showNotification("Daylight mode active.");
            }

            // Aggressively remove focus
            const btn = document.getElementById('theme-toggle-btn');
            if (btn) btn.blur();

            renderTripList();
            renderItinerary();
        };

        const updateScrollLock = () => {
            const isOpen = !$('sidebar').classList.contains('closed') || !$('modal-container').classList.contains('hidden');
            document.body.classList.toggle('overflow-hidden', isOpen);
        };

        const formatDate = (dateStr) => {
            if (!dateStr) return 'Select Date';
            const d = new Date(dateStr + 'T00:00:00');
            if (isNaN(d.getTime())) return dateStr;
            return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        };

        const toggleSidebar = () => {
            $('sidebar').classList.toggle('closed');
            $('sidebar-overlay').classList.toggle('hidden');
            updateScrollLock();
        };

        window.autoResize = (el) => {
            // Store current scroll positions
            const scrollLeft = window.scrollX;
            const scrollTop = window.scrollY;

            // Find parent scroll container (modal content)
            const parent = el.closest('.overflow-y-auto');
            const parentScrollTop = parent ? parent.scrollTop : 0;

            el.style.height = 'auto';
            el.style.height = (el.scrollHeight + 2) + 'px';

            // Restore scroll positions
            window.scrollTo(scrollLeft, scrollTop);
            if (parent) {
                parent.scrollTop = parentScrollTop;

                // If element bottom is obscured, scroll to show it
                // Using getBoundingClientRect to avoid offsetTop nesting issues
                const elRect = el.getBoundingClientRect();
                const parentRect = parent.getBoundingClientRect();

                // If the bottom of the element is below the bottom of the parent (minus a small buffer for border/padding)
                // We calculate how much it is overflowing
                const overflow = elRect.bottom - (parentRect.bottom - 10);

                if (overflow > 0) {
                    parent.scrollTop += overflow;
                }
            }
        };

        const getMemorySuggestions = (field, query) => {
            if (!query || query.length < 1) return [];
            let values = [];
            trips.forEach(t => t.plans?.forEach(p => {
                if (field === 'title' && p.title) values.push(p.title);
                if (field === 'location' && p.location) values.push(p.location);
            }));
            return [...new Set(values)].filter(v => v.toLowerCase().includes(query.toLowerCase())).slice(0, 5);
        };

        const handleSuggestionInput = (e, field) => {
            const query = e.target.value;
            const suggestions = getMemorySuggestions(field, query);
            const container = $(`suggestions-${field}`);
            if (suggestions.length > 0) {
                container.innerHTML = suggestions.map(s => `<div class="suggestion-item" onclick="applySuggestion('${field}', '${s.replace(/'/g, "\\'")}')">${s}</div>`).join('');
                container.style.display = 'block';
            } else container.style.display = 'none';
        };

        window.applySuggestion = (field, val) => {
            const input = $(`modal-plan-${field}`);
            if (input) { input.value = val; $(`suggestions-${field}`).style.display = 'none'; input.focus(); }
        };

        const updateDateDisplayUI = () => {
            const startBox = $('date-box-start');
            const endBox = $('date-box-end');
            const startTxt = $('txt-start-date');
            const endTxt = $('txt-end-date');
            if (!startBox || !endBox) return;
            startTxt.textContent = formatDate(calSelectionStart);
            endTxt.textContent = formatDate(calSelectionEnd);
            if (!calSelectionStart && !calSelectionEnd) {
                startBox.classList.add('date-box-active');
                endBox.classList.remove('date-box-active');
            } else if (calSelectionStart && !calSelectionEnd) {
                startBox.classList.remove('date-box-active');
                endBox.classList.add('date-box-active');
            } else if (calSelectionStart && calSelectionEnd) {
                startBox.classList.add('date-box-active');
                endBox.classList.remove('date-box-active');
            }
        };

        const renderCalendar = () => {
            const grid = $('calendar-days-grid');
            const monthLabel = $('cal-month-year');
            if (!grid || !monthLabel) return;
            grid.innerHTML = '';
            const firstDate = new Date(calCurrentYear, calCurrentMonth, 1);
            monthLabel.textContent = firstDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            const firstDayIndex = firstDate.getDay();
            const daysInMonth = new Date(calCurrentYear, calCurrentMonth + 1, 0).getDate();
            for (let i = 0; i < firstDayIndex; i++) grid.appendChild(document.createElement('div'));
            for (let i = 1; i <= daysInMonth; i++) {
                const monthStr = String(calCurrentMonth + 1).padStart(2, '0');
                const dayStr = String(i).padStart(2, '0');
                const dateStr = `${calCurrentYear}-${monthStr}-${dayStr}`;
                const btn = document.createElement('div');
                btn.className = 'calendar-day-btn';
                btn.textContent = i;
                if (dateStr === calSelectionStart) {
                    btn.classList.add('is-start');
                    if (calSelectionEnd) btn.classList.add('has-end');
                } else if (dateStr === calSelectionEnd) {
                    btn.classList.add('is-end');
                    if (calSelectionStart) btn.classList.add('has-start');
                } else if (calSelectionStart && calSelectionEnd && dateStr > calSelectionStart && dateStr < calSelectionEnd) {
                    btn.classList.add('in-range');
                }
                btn.onclick = () => {
                    if (!calSelectionStart || (calSelectionStart && calSelectionEnd)) {
                        calSelectionStart = dateStr;
                        calSelectionEnd = null;
                    } else if (dateStr < calSelectionStart) {
                        calSelectionStart = dateStr;
                    } else {
                        calSelectionEnd = dateStr;
                    }
                    renderCalendar();
                    updateDateDisplayUI();
                };
                grid.appendChild(btn);
            }
        };

        const changeCalMonth = (step) => {
            calCurrentMonth += step;
            if (calCurrentMonth < 0) { calCurrentMonth = 11; calCurrentYear--; }
            else if (calCurrentMonth > 11) { calCurrentMonth = 0; calCurrentYear++; }
            renderCalendar();
        };

        const refreshUI = async () => {
            try {
                const loadedTrips = await window.loadAll();
                trips = loadedTrips;
                if (activeTrip) {
                    const dbVersion = trips.find(t => t.id === activeTrip.id);
                    if (dbVersion) activeTrip = dbVersion;
                }
                if (!activeTrip && trips.length > 0) activeTrip = trips[0];
                renderTripList(); renderItinerary();
                const loader = $('loader');
                if (loader) { loader.classList.add('opacity-0'); setTimeout(() => loader.style.display = 'none', 700); }
            } catch (err) {
                log(err.message, 'ERROR');
            }
        };

        const renderTripList = () => {
            $('trip-list').innerHTML = trips.map(t => {
                const isSelected = activeTrip?.id === t.id;
                const borderClass = 'border-[var(--card-selected-border)]';
                const bgClass = isSelected ? 'bg-[var(--card-selected-bg)] shadow-sm' : 'bg-transparent';

                return `<div onclick="setActiveTrip('${t.id}')" class="p-4 rounded-lg cursor-pointer border ${borderClass} ${bgClass}">
                    <h4 class="text-current font-bold truncate opacity-100">${escapeHtml(t.name || '')}</h4>
                    <p class="text-muted text-xs mt-1 font-medium opacity-100">${formatDate(t.startDate)} - ${formatDate(t.endDate)}</p>
                </div>`;
            }).join('');

            // Check sticky state after rendering
            requestAnimationFrame(handleStickyHeaders);
        };

        const setActiveTrip = (id) => {
            activeTrip = trips.find(t => t.id === id);
            renderTripList();
            if (!$('sidebar').classList.contains('closed')) toggleSidebar();
            renderItinerary();
            window.scrollTo(0, 0);
        };

        const toggleDayCollapse = (date) => {
            const key = activeTrip.id + '_' + date;
            collapsedDays[key] = !collapsedDays[key];
            localStorage.setItem(COLLAPSE_KEY, JSON.stringify(collapsedDays));
            const dayGroup = document.querySelector(`.day-group[data-date="${date}"]`);
            if (dayGroup) {
                const header = dayGroup.querySelector('.day-header');
                const contentWrapper = dayGroup.querySelector('.day-content-wrapper');
                if (collapsedDays[key]) {
                    header.classList.add('collapsed');
                    contentWrapper.classList.add('collapsed');
                } else {
                    header.classList.remove('collapsed');
                    contentWrapper.classList.remove('collapsed');
                }
            } else {
                renderItinerary();
            }
        };

        const renderItinerary = () => {
            const container = $('itinerary-list'), hero = $('trip-hero'), empty = $('empty-state'), title = $('trip-header-title');
            if (!activeTrip) { container.innerHTML = ''; hero.classList.add('hidden'); empty.classList.remove('hidden'); title.innerText = "VOYAGER"; $('edit-current-trip').classList.add('hidden'); return; }
            empty.classList.add('hidden'); hero.classList.remove('hidden'); title.innerText = activeTrip.name;
            $('hero-img').src = `https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?auto=format&fit=crop&q=80&w=1200`;
            $('hero-title').innerText = activeTrip.name;
            $('hero-dates').innerHTML = `<i class="fa-solid fa-calendar-days mr-2"></i> ${formatDate(activeTrip.startDate)} â€” ${formatDate(activeTrip.endDate)}`;
            $('edit-current-trip').classList.remove('hidden'); $('edit-current-trip').onclick = () => openTripModal(activeTrip);
            let days = []; let current = new Date(activeTrip.startDate + 'T00:00:00'); const end = new Date(activeTrip.endDate + 'T00:00:00');
            if (isNaN(current.getTime()) || isNaN(end.getTime()) || current > end) {
                if (activeTrip.startDate) days.push(activeTrip.startDate);
            } else {
                let safety = 0;
                while(current <= end && safety < 366) {
                    const y = current.getFullYear(), m = String(current.getMonth() + 1).padStart(2, '0'), d = String(current.getDate()).padStart(2, '0');
                    days.push(`${y}-${m}-${d}`); current.setDate(current.getDate() + 1); safety++;
                }
            }
            container.innerHTML = `<div id="global-drag-indicator"></div>` + days.map((date, idx) => {
                const dayPlans = (activeTrip.plans || []).filter(p => p.date === date).sort((a,b) => (a.order || 0) - (b.order || 0) || (a.time || '').localeCompare(b.time || ''));
                const isCollapsed = collapsedDays[activeTrip.id + '_' + date];
                return `
                    <div class="day-group" data-date="${date}" ondragover="onDayDragOver(event)" ondragleave="onDayDragLeave(event)" ondrop="onDayDrop(event, '${date}')">
                        <div class="day-header glass rounded-lg px-4 py-1.5 mb-2 flex justify-between items-center w-[95%] md:w-[99%] mx-auto ${isCollapsed ? 'collapsed' : ''}" draggable="true" ondragstart="onDayDragStart(event, '${date}')" onclick="toggleDayCollapse('${date}')">
                            <div class="flex items-center">
                                <div>
                                    <span class="text-blue-600 text-[10px] font-black uppercase tracking-widest">Day ${idx + 1}</span>
                                    <h3 class="text-current font-extrabold text-base">${formatDate(date)}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="day-content-wrapper ${isCollapsed ? 'collapsed' : ''}">
                            <div class="day-content-inner">
                                <div class="space-y-[18px] pt-4 pb-6">
                                    ${dayPlans.map(p => `
                                        <!-- Fixed height h-20 (80px) for 2 lines with padding -->
                                        <div draggable="true"
                                             data-id="${p.id}"
                                             data-order="${p.order}"
                                             ondragstart="onPlanDragStart(event, '${p.id}')"
                                             ondragover="onPlanDragOver(event)"
                                             ondragleave="onPlanDragLeave(event)"
                                             ondrop="onPlanDrop(event, '${p.id}')"
                                             onclick="viewPlanModal('${p.id}')"
                                             class="plan-item h-16 md:h-20 rounded-lg p-2 flex items-center cursor-pointer transition-all group w-[90.25%] md:w-[94.05%] mx-auto hover:shadow-md">
                                            <div class="status-fin fin-${p.status || 'Tentative'}"></div>
                                            <div class="flex-grow pl-2 z-10 overflow-hidden w-full min-w-0">
                                                <!-- Title: Truncated to 1 line -->
                                                <h5 class="text-current font-bold transition-colors text-sm md:text-base mb-1 truncate">${escapeHtml(p.title || '')}</h5>

                                                <!-- Subtitle: Time (fixed) & Location (Marquee if needed) -->
                                                <div class="flex items-center text-xs md:text-sm text-muted font-medium w-full overflow-hidden min-w-0">
                                                    <span class="whitespace-nowrap flex-shrink-0 mr-1">${p.time || '--:--'} &middot;</span>
                                                    <div class="marquee-container">
                                                        <div class="marquee-content location-text">${p.location ? escapeHtml(p.location) : 'No location specified'}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>`).join('')}

                                    <div onclick="openPlanModal(null, '${date}')" class="h-[56px] w-[90.25%] md:w-[94.05%] mx-auto flex items-center justify-center border-2 border-dashed border-slate-200 dark:border-slate-700 bg-transparent dark:bg-slate-800/30 rounded-lg text-sm font-medium text-slate-500 dark:text-slate-400 cursor-pointer">
                                        Tap here to add new plan
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
            }).join('');

            // Post-render: Check for location overflow and apply marquee
            requestAnimationFrame(() => {
                document.querySelectorAll('.marquee-container').forEach(container => {
                    const content = container.querySelector('.marquee-content');
                    if (content && content.scrollWidth > container.clientWidth) {
                        // Clone content to make loop smoother or just add padding for simple scroll
                        // Simple linear scroll request
                        container.classList.add('marquee-active');
                        // Optional: Duplicate content for seamless loop effect
                        const clone = content.cloneNode(true);
                        clone.setAttribute('aria-hidden', 'true');
                        container.appendChild(clone);
                    }
                });
            });
        };

        const openTripModal = (trip = null) => {
            calSelectionStart = trip?.startDate || null; calSelectionEnd = trip?.endDate || null;
            const d = trip ? new Date(trip.startDate) : new Date();
            calCurrentMonth = d.getMonth(); calCurrentYear = d.getFullYear();
            $('modal-content').innerHTML = `
                <div class="flex-1 overflow-y-auto min-h-0 -ml-1 pl-1 -mr-2 pr-2">
                    <h2 class="text-2xl font-black text-current italic uppercase tracking-tighter mb-6 text-center leading-none">${trip ? 'Edit Journey' : 'New Journey'}</h2>
                    <div class="space-y-6">
                        <div class="floating-group">
                            <input id="m-trip-name" type="text" placeholder=" " autocomplete="off" class="floating-input" value="${escapeHtml(trip?.name || '')}">
                            <label class="floating-label">Trip Name</label>
                        </div>
                        <div>
                            <div class="flex space-x-2 mb-3">
                                <div id="date-box-start" class="flex-1 p-3 border border-[var(--input-border)] rounded-lg text-center bg-[var(--input-bg)] transition-all duration-200">
                                    <span class="text-[10px] text-muted block uppercase font-black tracking-widest leading-none mb-1">Start Date</span>
                                    <span id="txt-start-date" class="text-sm font-semibold"></span>
                                </div>
                                <div id="date-box-end" class="flex-1 p-3 border border-[var(--input-border)] rounded-lg text-center bg-[var(--input-bg)] transition-all duration-200">
                                    <span class="text-[10px] text-muted block uppercase font-black tracking-widest leading-none mb-1">End Date</span>
                                    <span id="txt-end-date" class="text-sm font-semibold"></span>
                                </div>
                            </div>
                            <div class="border border-[var(--input-border)] rounded-lg p-4 bg-[var(--input-bg)] overflow-hidden">
                                <div class="flex justify-between items-center mb-4">
                                    <button onclick="changeCalMonth(-1)" class="p-1 hover:bg-slate-100/10 rounded-full transition"><i class="fa-solid fa-chevron-left text-xs"></i></button>
                                    <span id="cal-month-year" class="font-bold text-xs uppercase tracking-wider"></span>
                                    <button onclick="changeCalMonth(1)" class="p-1 hover:bg-slate-100/10 rounded-full transition"><i class="fa-solid fa-chevron-right text-xs"></i></button>
                                </div>
                                <div class="grid grid-cols-7 gap-1 mb-2">${['S','M','T','W','T','F','S'].map(d => `<div class="text-center text-[10px] font-bold text-muted">${d}</div>`).join('')}</div>
                                <div id="calendar-days-grid" class="grid grid-cols-7 gap-y-1 min-h-[250px] content-start"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex-shrink-0 pt-4 mt-auto">
                    <div class="flex space-x-3">
                        ${trip ? `<button onclick="handleDeleteTrip('${trip.id}')" class="px-4 text-rose-500 font-bold hover:bg-rose-50 rounded-lg transition-all text-sm">Delete</button>` : ''}
                        <div class="flex-grow"></div>
                        <button onclick="closeModal()" class="px-4 text-muted font-bold hover:text-current transition-all text-sm text-center">Cancel</button>
                        <button onclick="handleSaveTrip('${trip?.id || ''}')" class="px-8 py-3 bg-accent text-white font-bold rounded-lg transition-all shadow-lg text-sm text-center">Save</button>
                    </div>
                </div>`;
            renderCalendar(); updateDateDisplayUI();
            $('modal-container').classList.replace('hidden', 'flex'); updateScrollLock();
        };

        const viewPlanModal = (planId) => {
            const plan = activeTrip.plans.find(p => p.id === planId); if (!plan) return;
            $('modal-content').innerHTML = `
                <div class="flex-1 overflow-y-auto min-h-0 -ml-1 pl-1 -mr-2 pr-2">
                    <div class="flex justify-between items-start mb-6 w-full">
                        <div class="min-w-0 pr-2">
                            <span class="text-blue-600 text-[10px] font-black uppercase tracking-widest block mb-1">${plan.category || 'Plan'}</span>
                            <h2 class="text-2xl font-black text-current italic uppercase tracking-tighter break-words">${escapeHtml(plan.title || '')}</h2>
                        </div>
                        <div class="px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-tighter bg-accent/10 text-accent border border-accent/20 flex-shrink-0">${plan.status || 'Tentative'}</div>
                    </div>
                    <div class="space-y-4 mb-8">
                        <div class="flex items-center p-3 rounded-lg bg-[var(--bg-color)] border border-[var(--card-border)]">
                            <div class="w-8 h-8 rounded-full bg-accent/10 text-accent flex items-center justify-center mr-3 flex-shrink-0"><i class="fa-solid fa-calendar-day text-xs"></i></div>
                            <div class="min-w-0"><p class="text-[10px] text-muted font-bold uppercase leading-none mb-1">Date & Time</p><p class="text-sm font-semibold break-words">${formatDate(plan.date)} ${plan.time ? 'at ' + plan.time : ''}</p></div>
                        </div>
                        <div class="flex items-center p-3 rounded-lg bg-[var(--bg-color)] border border-[var(--card-border)]">
                            <div class="w-8 h-8 rounded-full bg-accent/10 text-accent flex items-center justify-center mr-3 flex-shrink-0"><i class="fa-solid fa-location-dot text-xs"></i></div>
                            <div class="min-w-0"><p class="text-[10px] text-muted font-bold uppercase leading-none mb-1">Location Address</p><p class="text-sm font-semibold break-words">${escapeHtml(plan.location || 'Not specified')}</p></div>
                        </div>
                        ${plan.mapLink ? `
                        <a href="${escapeHtml(plan.mapLink)}" target="_blank" class="flex items-center p-3 rounded-lg bg-[var(--bg-color)] border border-[var(--card-border)] hover:bg-[var(--card-selected-bg)] hover:border-[var(--accent-blue)] transition-colors group">
                            <div class="w-8 h-8 rounded-full bg-accent/10 text-accent group-hover:bg-accent group-hover:text-white transition-colors flex items-center justify-center mr-3 flex-shrink-0"><i class="fa-solid fa-map-location-dot text-xs"></i></div>
                            <div class="min-w-0"><p class="text-[10px] text-muted font-bold uppercase leading-none mb-1">View on Map</p><p class="text-sm font-semibold break-words text-accent group-hover:text-current">Open Link <i class="fa-solid fa-arrow-up-right-from-square ml-1 text-xs opacity-50"></i></p></div>
                        </a>` : ''}
                        ${plan.location ? `
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(plan.location)}&travelmode=transit" target="_blank" class="flex items-center p-3 rounded-lg bg-[var(--bg-color)] border border-[var(--card-border)] hover:bg-[var(--card-selected-bg)] hover:border-[var(--accent-blue)] transition-colors group">
                            <div class="w-8 h-8 rounded-full bg-accent/10 text-accent group-hover:bg-accent group-hover:text-white transition-colors flex items-center justify-center mr-3 flex-shrink-0"><i class="fa-solid fa-train-subway text-xs"></i></div>
                            <div class="min-w-0"><p class="text-[10px] text-muted font-bold uppercase leading-none mb-1">Transit Directions</p><p class="text-sm font-semibold break-words text-accent group-hover:text-current">Get Directions <i class="fa-solid fa-arrow-up-right-from-square ml-1 text-xs opacity-50"></i></p></div>
                        </a>` : ''}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div class="flex items-center p-3 rounded-lg bg-[var(--bg-color)] border border-[var(--card-border)]">
                                <div class="w-8 h-8 rounded-full bg-accent/10 text-accent flex items-center justify-center mr-3 flex-shrink-0"><i class="fa-solid fa-receipt text-xs"></i></div>
                                <div class="min-w-0 flex-1"><p class="text-[10px] text-muted font-bold uppercase leading-none mb-1">Cost</p><p class="text-sm font-semibold break-all">${escapeHtml(plan.cost || '-')}</p></div>
                            </div>
                            <div class="flex items-center p-3 rounded-lg bg-[var(--bg-color)] border border-[var(--card-border)]">
                                <div class="w-8 h-8 rounded-full bg-accent/10 text-accent flex items-center justify-center mr-3 flex-shrink-0"><i class="fa-solid fa-ticket text-xs"></i></div>
                                <div class="min-w-0 flex-1"><p class="text-[10px] text-muted font-bold uppercase leading-none mb-1">Booking Ref</p><p class="text-sm font-semibold break-all">${escapeHtml(plan.bookingRef || '-')}</p></div>
                            </div>
                        </div>
                        <div class="p-3 rounded-lg bg-[var(--bg-color)] border border-[var(--card-border)]">
                            <p class="text-[10px] text-muted font-bold uppercase leading-none mb-1">Notes</p>
                            <p class="text-sm italic break-words whitespace-pre-wrap">${escapeHtml(plan.details || 'No additional notes provided.')}</p>
                        </div>
                    </div>
                </div>
                <div class="flex-shrink-0 pt-4 mt-auto">
                    <div class="flex space-x-3">
                        <button onclick="closeModal()" class="flex-1 py-4 text-muted font-bold hover:text-current transition-all text-sm text-center">Close</button>
                        <button onclick="openPlanModal('${plan.id}')" class="flex-1 py-4 bg-accent text-white font-bold rounded-lg shadow-lg text-sm text-center">Edit Plan</button>
                    </div>
                </div>`;
            $('modal-container').classList.replace('hidden', 'flex'); updateScrollLock();
        };

        const openPlanModal = (planId = null, defaultDate = null) => {
            const plan = activeTrip.plans?.find(p => p.id === planId) || null;
            const categories = ['Activity', 'Flight', 'Hotel', 'Food', 'Transport', 'Sightseeing'];
            $('modal-content').innerHTML = `
                <div class="flex-1 overflow-y-auto min-h-0 -ml-1 pl-1 -mr-2 pr-2 pb-2">
                    <h2 class="text-2xl font-black text-current italic uppercase tracking-tighter mb-6 text-center leading-none">${plan ? 'Edit Plan' : 'New Plan'}</h2>
                    <div class="space-y-5">
                        <div class="floating-group">
                            <input id="modal-plan-title" type="text" placeholder=" " autocomplete="off" oninput="handleSuggestionInput(event, 'title')" onblur="setTimeout(() => $('suggestions-title').style.display = 'none', 200)" class="floating-input" value="${escapeHtml(plan?.title || '')}">
                            <label class="floating-label">Activity Title</label>
                            <div id="suggestions-title" class="suggestions-list"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="floating-group">
                                <select id="modal-plan-category" class="floating-select">${categories.map(c => `<option value="${c}" ${plan?.category === c ? 'selected' : ''}>${c}</option>`).join('')}</select>
                                <label class="floating-label">Category</label>
                            </div>
                            <div class="floating-group">
                                <select id="modal-plan-status" class="floating-select">
                                    <option value="Tentative" ${plan?.status === 'Tentative' ? 'selected' : ''}>Tentative</option>
                                    <option value="Confirmed" ${plan?.status === 'Confirmed' ? 'selected' : ''}>Confirmed</option>
                                    <option value="Cancelled" ${plan?.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                                </select>
                                <label class="floating-label">Booking Status</label>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="floating-group">
                                <input id="modal-plan-date" type="date" class="floating-input" value="${plan?.date || defaultDate || ''}">
                                <label class="floating-label">Date</label>
                            </div>
                            <div class="floating-group">
                                <input id="modal-plan-time" type="time" class="floating-input" value="${plan?.time || ''}">
                                <label class="floating-label">Time</label>
                            </div>
                        </div>
                        <div class="floating-group">
                            <input id="modal-plan-location" type="text" placeholder=" " autocomplete="off" oninput="handleSuggestionInput(event, 'location')" onblur="setTimeout(() => $('suggestions-location').style.display = 'none', 200)" class="floating-input" value="${escapeHtml(plan?.location || '')}">
                            <label class="floating-label">Location Address</label>
                            <div id="suggestions-location" class="suggestions-list"></div>
                        </div>
                        <div class="floating-group">
                            <input id="modal-plan-maplink" type="text" placeholder=" " class="floating-input" value="${escapeHtml(plan?.mapLink || '')}">
                            <label class="floating-label">Map Link (Google Maps URL)</label>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="floating-group">
                                <input id="modal-plan-cost" type="text" placeholder=" " class="floating-input" value="${escapeHtml(plan?.cost || '')}">
                                <label class="floating-label">Cost</label>
                            </div>
                            <div class="floating-group">
                                <input id="modal-plan-booking" type="text" placeholder=" " class="floating-input" value="${escapeHtml(plan?.bookingRef || '')}">
                                <label class="floating-label">Booking Ref</label>
                            </div>
                        </div>
                        <div class="floating-group">
                            <textarea id="modal-plan-details" placeholder=" " oninput="autoResize(this)" class="floating-textarea">${escapeHtml(plan?.details || '')}</textarea>
                            <label class="floating-label">Notes</label>
                        </div>
                    </div>
                </div>
                <div class="flex-shrink-0 pt-4 mt-auto">
                    <div class="flex space-x-3">
                        ${plan ? `<button onclick="handleDeletePlan('${plan.id}')" class="px-4 text-rose-500 font-bold text-sm text-center">Delete</button>` : ''}
                        <div class="flex-grow"></div>
                        <button onclick="${plan ? `viewPlanModal('${plan.id}')` : 'closeModal()'}" class="px-6 py-4 text-muted font-bold hover:text-current transition-all text-sm text-center">Cancel</button>
                        <button onclick="handleSavePlan('${plan?.id || ''}')" class="px-8 py-3 bg-accent text-white font-bold rounded-lg transition-all shadow-lg text-sm text-center">Save</button>
                    </div>
                </div>`;
            $('modal-container').classList.replace('hidden', 'flex');

            const txt = $('modal-plan-details'); if(txt) autoResize(txt);

            // Force scroll to top
            const modalBody = $('modal-content').querySelector('.overflow-y-auto');
            if (modalBody) modalBody.scrollTop = 0;

            updateScrollLock();
        };

        const closeModal = () => { $('modal-container').classList.replace('flex', 'hidden'); updateScrollLock(); };

        const handleSaveTrip = async (id, force = false) => {
            const name = force && pendingTripCache ? pendingTripCache.name : $('m-trip-name')?.value;
            const start = force && pendingTripCache ? pendingTripCache.start : calSelectionStart;
            const end = force && pendingTripCache ? pendingTripCache.end : calSelectionEnd;

            if(!name || !start || !end) return showNotification("Missing fields.");

            const data = id ? trips.find(t => t.id === id) : { id: 't_' + Date.now(), plans: [] };

            if (id && !force && data.plans?.some(p => p.date < start || p.date > end)) {
                pendingTripCache = { name, start, end };
                $('modal-content').innerHTML = `
                    <div class="flex-1 overflow-y-auto min-h-0 -ml-1 pl-1 -mr-2 pr-2">
                        <div class="text-center">
                            <h2 class="text-2xl font-black text-current italic uppercase mb-4 text-center leading-none">Date Conflict</h2>
                            <p class="text-muted mb-8 text-sm text-center">Changing dates will remove plans outside the window.</p>
                        </div>
                    </div>
                    <div class="flex-shrink-0 pt-4 mt-auto">
                        <button onclick="handleSaveTrip('${id}', true)" class="w-full py-4 bg-accent text-white font-bold rounded-lg text-sm mb-2 shadow-lg">Save & Remove</button>
                        <button onclick="openTripModal(activeTrip)" class="w-full py-4 text-muted font-bold text-sm text-center">Back</button>
                    </div>`;
                return;
            }

            const trip = { ...data, name, startDate: start, endDate: end };
            trip.plans = (trip.plans || []).filter(p => p.date >= trip.startDate && p.date <= trip.endDate);

            await saveToDB(trip);
            activeTrip = trip;

            closeModal();
            await refreshUI();

            if (!$('sidebar').classList.contains('closed')) {
                toggleSidebar();
            }

            showNotification("Journey synced.");
            pendingTripCache = null;
            window.scrollTo(0, 0);
        };

        const _executeDeleteTrip = async (id) => { await deleteFromDB(id); activeTrip = null; closeModal(); refreshUI(); showNotification("Journey deleted."); };

        const handleSavePlan = async (id) => {
            const title = $('modal-plan-title').value, date = $('modal-plan-date').value;
            if(!title || !date) return showNotification("Title and date required.");
            if(!activeTrip.plans) activeTrip.plans = [];

            const finalId = id || 'p_' + Date.now();

            const pData = {
                id: finalId, title, date, time: $('modal-plan-time').value, location: $('modal-plan-location').value, mapLink: $('modal-plan-maplink').value,
                status: $('modal-plan-status').value, category: $('modal-plan-category').value, cost: $('modal-plan-cost').value,
                bookingRef: $('modal-plan-booking').value, details: $('modal-plan-details').value,
                order: id ? (activeTrip.plans.find(p => p.id === id)?.order || 0) : activeTrip.plans.length
            };
            const idx = activeTrip.plans.findIndex(p => p.id === id); if(idx > -1) activeTrip.plans[idx] = pData; else activeTrip.plans.push(pData);

            await saveToDB(activeTrip);
            await refreshUI();
            viewPlanModal(finalId);
            showNotification("Itinerary updated.");
        };

        const handleDeletePlan = async (id) => { if (activeTrip && activeTrip.plans) { activeTrip.plans = activeTrip.plans.filter(p => p.id !== id); await saveToDB(activeTrip); } closeModal(); refreshUI(); showNotification("Plan removed."); };

        let draggedPlanId = null, draggedDayDate = null, dropPosition = 'bottom', currentLogicalIndex = null, dragLeaveTimer = null;

        const createDragGhost = (sourceEl) => {
            const clone = sourceEl.cloneNode(true);

            // 1. Lock dimensions to match original EXACTLY
            const width = sourceEl.offsetWidth;
            const height = sourceEl.offsetHeight;

            clone.style.width = width + 'px';
            clone.style.height = height + 'px';

            // 2. Position off-screen but renderable
            clone.style.position = 'absolute';
            clone.style.top = '-9999px';
            clone.style.left = '0';
            clone.style.zIndex = '-1';

            // 3. Strict Clipping & Layout Reset
            // This is the "Nuclear Option" to ensure no overflowing text expands the drag layer
            clone.style.overflow = 'hidden';
            clone.style.transform = 'none'; // No scale(0.98)
            clone.style.transition = 'none';
            clone.style.boxShadow = 'none'; // Optional: clean look

            // 4. Flatten marquee structure to simple static text
            // We search for marquee content and replace it with a simple, constrained text node
            // This eliminates any complex flex/animation layout shifts in the ghost
            const marqueeContent = clone.querySelector('.marquee-content');
            const marqueeContainer = clone.querySelector('.marquee-container');

            if (marqueeContent && marqueeContainer) {
                const text = marqueeContent.innerText;
                const staticDiv = document.createElement('div');
                staticDiv.className = 'text-xs md:text-sm text-muted font-medium w-full overflow-hidden whitespace-nowrap truncate';
                staticDiv.innerText = text;

                // Replace the entire marquee container structure with this static div
                marqueeContainer.replaceWith(staticDiv);
            }

            document.body.appendChild(clone);
            return clone;
        };

        const onPlanDragStart = (e, id) => {
            e.stopPropagation();
            draggedPlanId = id;
            draggedDayDate = null;

            // Use Clone Strategy for Ghost Image
            // This guarantees the browser snapshots a strictly sized box,
            // ignoring any internal overflow from the live element.
            if (e.dataTransfer) {
                const ghost = createDragGhost(e.target);

                // Set the drag image to the centered clone
                e.dataTransfer.setDragImage(ghost, e.target.offsetWidth / 2, e.target.offsetHeight / 2);

                // Remove clone after snapshot is taken (next tick)
                setTimeout(() => ghost.remove(), 0);
            }

            e.target.classList.add('dragging');
        };
        const onDayDragStart = (e, date) => { draggedDayDate = date; draggedPlanId = null; e.currentTarget.closest('.day-group').classList.add('dragging'); };
        const onDayDragOver = (e) => {
            e.preventDefault();
            if (!draggedPlanId) {
                // Dragging a day, standard behavior
                const target = e.currentTarget;
                if (!target.classList.contains('drag-over-day')) {
                    document.querySelectorAll('.drag-over-day').forEach(el => el.classList.remove('drag-over-day'));
                    target.classList.add('drag-over-day');
                }
                return;
            }

            // Dragging a plan
            const draggedPlan = activeTrip.plans.find(p => p.id === draggedPlanId);
            if (!draggedPlan) return;

            const target = e.currentTarget;
            const targetDate = target.getAttribute('data-date');

            // Condition: Different day AND target day has NO plans
            const targetPlans = activeTrip.plans.filter(p => p.date === targetDate);
            const isDifferentDay = draggedPlan.date !== targetDate;
            const isEmptyDay = targetPlans.length === 0;

            if (isDifferentDay && isEmptyDay) {
                if (!target.classList.contains('drag-over-day')) {
                    document.querySelectorAll('.drag-over-day').forEach(el => el.classList.remove('drag-over-day'));
                    target.classList.add('drag-over-day');
                }
            } else {
                target.classList.remove('drag-over-day');
            }
        };
        const onDayDragLeave = (e) => {
            if (!e.currentTarget.contains(e.relatedTarget)) {
                e.currentTarget.classList.remove('drag-over-day');
            }
        };
        const onPlanDragLeave = (e) => {
            const indicator = $('global-drag-indicator');
            if (indicator) {
                if (dragLeaveTimer) clearTimeout(dragLeaveTimer);
                // Debounce hide to prevent flicker when moving between adjacent items
                dragLeaveTimer = setTimeout(() => {
                    indicator.style.display = 'none';
                }, 50);
            }
        };
        const onPlanDragOver = (e) => {
            e.preventDefault(); e.stopPropagation();
            if (!draggedPlanId) return;

            // Cancel any pending hide action immediately upon entering a new valid target
            if (dragLeaveTimer) {
                clearTimeout(dragLeaveTimer);
                dragLeaveTimer = null;
            }

            const targetEl = e.currentTarget;
            const targetId = targetEl.getAttribute('data-id');
            const indicator = $('global-drag-indicator');

            // 1. Redundancy: Hovering over self
            if (draggedPlanId === targetId) {
                if(indicator) indicator.style.display = 'none';
                return;
            }

            const draggedPlan = activeTrip.plans.find(p => p.id === draggedPlanId);
            const targetPlan = activeTrip.plans.find(p => p.id === targetId);

            if (!draggedPlan || !targetPlan) return;

            const rect = targetEl.getBoundingClientRect();
            const midpoint = rect.top + (rect.height / 2);
            const side = e.clientY < midpoint ? 'top' : 'bottom';

            const targetOrder = parseInt(targetEl.getAttribute('data-order'));
            const currentOrder = draggedPlan.order || 0;

            // 2. Redundancy: Same Day Logic checks
            if (draggedPlan.date === targetPlan.date) {
                if ((side === 'top' && targetOrder === currentOrder + 1) ||
                    (side === 'bottom' && targetOrder === currentOrder - 1)) {
                     if(indicator) indicator.style.display = 'none';
                     return;
                }
            }

            // Global Indicator Positioning
            // Gap is 18px. Half is 9px.
            // Target Top: offsetTop - 9px.
            // Target Bottom: offsetTop + offsetHeight + 9px.
            // Note: offsetTop is relative to the day-content-inner.
            // We need position relative to #itinerary-list.

            // Calculating relative position manually to be safe against nesting
            const containerRect = $('itinerary-list').getBoundingClientRect();
            const relTop = rect.top - containerRect.top;

            // Adjust for border/padding?
            // The line height is 2px. Center is 1px.
            // Gap center is 9px from edge.
            // So visual center is Edge +/- 9px.
            // Top: relTop - 9px - 1px (center align) = relTop - 10px.
            // Bottom: relTop + rect.height + 9px - 1px = relTop + rect.height + 8px.

            const lineY = side === 'top' ? (relTop - 10) : (relTop + rect.height + 8);

            if (indicator) {
                indicator.style.display = 'block';
                indicator.style.top = `${lineY}px`;
                indicator.style.left = `${targetEl.offsetLeft}px`;
                indicator.style.width = `${targetEl.offsetWidth}px`;
            }

            currentLogicalIndex = side === 'top' ? targetOrder : targetOrder + 1;
            dropPosition = side;
        };

        const onPlanDrop = async (e, targetPlanId) => {
            e.preventDefault(); e.stopPropagation();
            const ind = $('global-drag-indicator');
            if (!ind || ind.style.display === 'none') return;

            if (!draggedPlanId || draggedPlanId === targetPlanId) return;
            const draggedPlan = activeTrip.plans.find(p => p.id === draggedPlanId), targetPlan = activeTrip.plans.find(p => p.id === targetPlanId);
            if (draggedPlan && targetPlan) {
                draggedPlan.date = targetPlan.date;
                let dayPlans = activeTrip.plans.filter(p => p.date === targetPlan.date && p.id !== draggedPlanId).sort((a,b) => (a.order || 0) - (b.order || 0));
                const targetIdx = dayPlans.findIndex(p => p.id === targetPlanId);
                const insertIdx = dropPosition === 'top' ? targetIdx : targetIdx + 1;
                dayPlans.splice(insertIdx, 0, draggedPlan); dayPlans.forEach((p, i) => p.order = i);
                await saveToDB(activeTrip); refreshUI();
            }
            draggedPlanId = null;
        };

        const onDayDrop = async (e, targetDate) => {
            e.preventDefault();
            const isEmptyDayDrop = e.currentTarget.classList.contains('drag-over-day');
            e.currentTarget.classList.remove('drag-over-day');

            if (!activeTrip) return;

            if (draggedDayDate) {
                if (draggedDayDate === targetDate) return;

                // Swap collapsed state
                const draggedKey = activeTrip.id + '_' + draggedDayDate;
                const targetKey = activeTrip.id + '_' + targetDate;
                const draggedState = collapsedDays[draggedKey];
                const targetState = collapsedDays[targetKey];
                collapsedDays[draggedKey] = targetState;
                collapsedDays[targetKey] = draggedState;
                localStorage.setItem(COLLAPSE_KEY, JSON.stringify(collapsedDays));

                activeTrip.plans = activeTrip.plans.map(p => {
                    if (p.date === draggedDayDate) return { ...p, date: targetDate };
                    if (p.date === targetDate) return { ...p, date: draggedDayDate };
                    return p;
                });
                await saveToDB(activeTrip); refreshUI(); showNotification("Day swapped.");
            } else if (draggedPlanId) {
                const plan = activeTrip.plans.find(p => p.id === draggedPlanId);
                if (plan && plan.date !== targetDate) {
                    // If moving to a different day, we strictly require a visual cue.
                    // For populated days, this would be the green line (handled by onPlanDrop).
                    // For empty days, this is the dashed outline (isEmptyDayDrop).
                    // If neither, we are dropping on the "background" of a populated day with no indicator -> Cancel.
                    if (!isEmptyDayDrop) return;

                    plan.date = targetDate;
                    const maxOrder = Math.max(...activeTrip.plans.filter(p => p.date === targetDate).map(p => p.order || 0), -1);
                    plan.order = maxOrder + 1; await saveToDB(activeTrip); refreshUI();
                }
                draggedPlanId = null;
            }
        };

        window.handleSaveTrip = handleSaveTrip; window.handleDeleteTrip = (id) => {
            $('modal-content').innerHTML = `
                <div class="flex-1 overflow-y-auto min-h-0 -ml-1 pl-1 -mr-2 pr-2">
                    <div class="text-center">
                        <div class="w-20 h-20 bg-rose-50 dark:bg-rose-900/20 rounded-lg flex items-center justify-center mx-auto mb-6">
                            <i class="fa-solid fa-trash-can text-3xl text-rose-500"></i>
                        </div>
                        <h2 class="text-2xl font-black text-current italic uppercase mb-4 text-center leading-none">Abort Journey?</h2>
                    </div>
                </div>
                <div class="flex-shrink-0 pt-4 mt-auto">
                    <button onclick="_executeDeleteTrip('${id}')" class="w-full py-4 bg-rose-600 text-white font-bold rounded-lg text-sm mb-2 shadow-lg">Delete Permanently</button>
                    <button onclick="closeModal()" class="w-full py-4 text-slate-400 font-bold hover:text-current transition-all text-sm text-center">Keep Journey</button>
                </div>`;
        };
        window._executeDeleteTrip = _executeDeleteTrip; window.handleSavePlan = handleSavePlan; window.handleDeletePlan = handleDeletePlan; window.closeModal = closeModal; window.openTripModal = openTripModal; window.openPlanModal = openPlanModal; window.viewPlanModal = viewPlanModal; window.toggleSidebar = toggleSidebar; window.toggleTheme = toggleTheme; window.setActiveTrip = setActiveTrip; window.toggleDayCollapse = toggleDayCollapse; window.changeCalMonth = changeCalMonth; window.handleSuggestionInput = handleSuggestionInput;
        window.refreshUI = refreshUI; window.loadAll = loadAll;
        window.onDayDragOver = onDayDragOver; window.onDayDragLeave = onDayDragLeave; window.onDayDrop = onDayDrop; window.onPlanDragStart = onPlanDragStart; window.onDayDragStart = onDayDragStart; window.onPlanDragOver = onPlanDragOver; window.onPlanDragLeave = onPlanDragLeave; window.onPlanDrop = onPlanDrop;

        let autoScrollInterval = null;
        const SCROLL_ZONE = 80;
        const SCROLL_SPEED = 15;

        const stopAutoScroll = () => {
            if (autoScrollInterval) {
                cancelAnimationFrame(autoScrollInterval);
                autoScrollInterval = null;
            }
        };

        const handleAutoScroll = (clientY) => {
            const h = window.innerHeight;
            let scrollStep = 0;

            if (clientY < SCROLL_ZONE) {
                scrollStep = -SCROLL_SPEED;
            } else if (clientY > h - SCROLL_ZONE) {
                scrollStep = SCROLL_SPEED;
            }

            if (scrollStep !== 0) {
                if (!autoScrollInterval) {
                    const scrollLoop = () => {
                        window.scrollBy(0, scrollStep);
                        autoScrollInterval = requestAnimationFrame(scrollLoop);
                    };
                    autoScrollInterval = requestAnimationFrame(scrollLoop);
                }
            } else {
                stopAutoScroll();
            }
        };

        window.addEventListener('dragover', (e) => {
            handleAutoScroll(e.clientY);
        }, { capture: true });

        window.addEventListener('dragend', (e) => {
            stopAutoScroll();
            const el = e.target;

            // Note: No style restoration needed for drag image as we used a clone.
            // Just general cleanup if we modified anything else.

            // Restore marquee state (if it was touched globally, but we only touched clone)
            if (el && el.querySelector) {
                const marquee = el.querySelector('.marquee-content');
                if (marquee) {
                    marquee.style.animation = '';
                    marquee.style.transform = '';
                }
            }

            // Immediate snap-back: disable transition temporarily
            if (el && el.style) {
                el.style.transition = 'none';
                requestAnimationFrame(() => {
                    el.style.transition = '';
                });
            }
            document.querySelectorAll('.dragging, .drag-over-day').forEach(el => el.classList.remove('dragging', 'drag-over-day'));
            const ind = $('global-drag-indicator'); if(ind) ind.style.display = 'none';
            if (dragLeaveTimer) clearTimeout(dragLeaveTimer);
            currentLogicalIndex = null;
        });

        const handleStickyHeaders = () => {
            const header = document.querySelector('header');
            if (!header) return;
            const headerHeight = header.offsetHeight;

            // Trigger stickiness when element slides under header by ~8px
            // headerHeight - 8 (overlap) + 1 (buffer)
            const threshold = headerHeight - 7;

            document.querySelectorAll('.day-header').forEach(el => {
                const rect = el.getBoundingClientRect();
                if (rect.top <= threshold) {
                    el.classList.add('is-stuck');
                } else {
                    el.classList.remove('is-stuck');
                }
            });
        };
        window.addEventListener('scroll', handleStickyHeaders);
        window.addEventListener('resize', handleStickyHeaders);

        window.onload = async () => { initTheme(); await initDB(); refreshUI(); };
    </script>
</body>
</html>